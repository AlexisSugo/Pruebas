console.log('Prueba para nuevos eventos');
("use strict");

(function ($, window, undefined) {
    let self;

    function EnhancedEcommerce() {
        // Variables Globaes
        self = this;

        self.Enhanced.init();
    }

    const Enhanced = {
        init() {
            $(document).ready(() => {
                this.triggers();
                this.events();
            });
        },

        triggers() {
            $(document)
                .on("enhancedController:addToCart", (e, element, quantity) => {
                    const productInfo = self.Enhanced.getProductInfo(element, quantity);
                    self.Enhanced.addToCart(productInfo);
                })
                .on("enhancedController:removeFromCart", (e, element) => {
                    const productInfo = self.Enhanced.getProductInfo(element);
                    self.Enhanced.removeFromCart(productInfo);
                })
                .on("enhancedController:productImpresion", (e, products) => {
                    self.Enhanced.productImpresion(products);
                })
                .on("enhancedController:productClick", (e, element, position, URL) => {
                    const productInfo = self.Enhanced.getProductInfo(element);
                    self.Enhanced.productClick(productInfo, position, URL);
                })
                .on("enhancedController:productDetailImpresion", (e, element) => {
                    const productInfo = self.Enhanced.getProductInfo(element);
                    self.Enhanced.productDetailImpresion(productInfo);
                })
                .on("enhancedController:company", (e, company) => {
                    self.Enhanced.company(company);
                });
            
                $('#sendInviteButton').click((e)=>{
                    e.preventDefault()
                    if($( "#sendInviteButton" ).hasClass( "error" )==false) {
                        console.log('manda evento')
                        //self.Enhanced.inviteReferrals();
                    }
                })

                $('.referrals>.shareLinkContainer>.socialSharing>.whatsapp').click(()=>{
                    self.Enhanced.whatsappClick()
                })
                
                $('.referrals>.shareLinkContainer>.socialSharing>.copy').click(()=>{
                    self.Enhanced.copyClick()
                })
        },

        events() {
            // Product Impresion
            let products = [];

            $(".vitrina").each((index, element) => {
                // Product Impresion
                products.push(self.Enhanced.getProductInfo($(element).children().first()));

                if (index === $(".vitrina").length - 1) {
                    $(document).trigger("enhancedController:productImpresion", [products]);
                }

                // Product Click
                $(element)
                    .find("a")
                    .click((e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        e.stopImmediatePropagation();

                        const URL = $(e.currentTarget).attr("href");
                        $(document).trigger("enhancedController:productClick", [e.currentTarget, index, URL]);
                    });
            });
        },

        unformatPrice(formatedPrice) {
            return formatedPrice.replace("S/ ", "");
        },

        getProductInfo(element, quantity = 0) {
            return {
                id: $(element).parents(".parentInfo").data("skuid"),
                name: $(element).parents(".parentInfo").data("name"),
                price: self.Enhanced.unformatPrice($(element).parents(".parentInfo").data("bestprice")),
                category: $(element).parents(".parentInfo").data("category"),
                brand: $(element).parents(".parentInfo").data("brand"),
                instock: $(element).parents(".parentInfo").data("instock"),
                quantity: Number.parseInt($(element).parents(".parentInfo").data("quantity") || quantity),
            };
        },

        addToCart({ id, name, price, category, brand, quantity }) {
            dataLayer.push({
                event: "addToCart",
                ecommerce: {
                    currencyCode: "PEN",
                    add: {
                        products: [
                            {
                                id,
                                name,
                                price,
                                category,
                                brand,
                                quantity,
                            },
                        ],
                    },
                },
            });
        },

        removeFromCart({ id, name, price, category, brand, quantity }) {
            dataLayer.push({
                event: "removeFromCart",
                ecommerce: {
                    currencyCode: "PEN",
                    add: {
                        products: [
                            {
                                id,
                                name,
                                price,
                                category,
                                brand,
                                quantity,
                            },
                        ],
                    },
                },
            });
        },

        productDetailImpresion({ id, name, price, category, brand }) {
            dataLayer.push({
                event: "productView",
                ecommerce: {
                    currencyCode: "PEN",
                    detail: {
                        products: [
                            {
                                id,
                                name,
                                price,
                                category,
                                brand,
                            },
                        ],
                    },
                },
            });
        },

        productImpresion(products) {
            const tempProducts = products.map(({ id, name, price, category, brand }, position) => ({
                id,
                name,
                price,
                category,
                brand,
                position,
            }));

            dataLayer.push({
                ecommerce: {
                    currencyCode: "PEN",
                    impressions: tempProducts,
                },
            });
        },

        productClick({ id, name, price, category, brand }, position, URL) {
            dataLayer.push({
                event: "productClick",
                ecommerce: {
                    click: {
                        products: [
                            {
                                id,
                                name,
                                price,
                                category,
                                brand,
                                position,
                            },
                        ],
                    },
                },
                eventCallback: () => {
                    if (!URL) {
                        window.location.pathname = "/";
                    } else {
                        window.location.href = URL;
                    }
                },
            });
        },

        company(company) {
            dataLayer.push({
                event: "companyUser",
                ecommerce: {
                    company_user: {
                        company,
                    },
                },
            });
        },

        inviteReferrals() {
           
                dataLayer.push({
                    event: "CEmailReferido",            
                });
            
        },

        whatsappClick() {
            dataLayer.push({
                event: "CEwhatsapp",            
            });
        },
        
        copyClick() {
            dataLayer.push({
                event: "CEcopiar",            
            });
        },
    };

    EnhancedEcommerce.prototype.Enhanced = Enhanced;

    return new EnhancedEcommerce(this);
})(jQuery, window);